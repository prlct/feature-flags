FROM node:16.15.1-alpine3.15 as base

ARG NODE_ENV=production
ARG APP_ENV
ARG NEXT_PUBLIC_APP_ENV=$APP_ENV
ARG NEXT_PUBLIC_MAGIC_PUBLISHABLE_KEY
ARG NEXT_PUBLIC_GROWTHFLAGS_PUBLIC_KEY
ARG NEXT_PUBLIC_CRISP_WEBSITE_ID
ARG NEXT_PUBLIC_HOTJAR_ID

ENV NODE_ENV=$NODE_ENV
ENV NEXT_PUBLIC_APP_ENV=$NEXT_PUBLIC_APP_ENV
ENV NEXT_PUBLIC_MAGIC_PUBLISHABLE_KEY: $NEXT_PUBLIC_MAGIC_PUBLISHABLE_KEY,
ENV NEXT_PUBLIC_GROWTHFLAGS_PUBLIC_KEY: $NEXT_PUBLIC_GROWTHFLAGS_PUBLIC_KEY,
ENV NEXT_PUBLIC_CRISP_WEBSITE_ID: $NEXT_PUBLIC_CRISP_WEBSITE_ID,
ENV NEXT_PUBLIC_HOTJAR_ID: $NEXT_PUBLIC_HOTJAR_ID,

RUN apk add --no-cache python3 make g++\
   && rm -rf /var/cache/apk/*

WORKDIR /app
EXPOSE 3002
COPY ["./package*.json", "/app/"]

RUN npm ci --quiet
COPY . ./

FROM base AS development
CMD npm run dev

FROM base AS release
RUN npm run build

CMD npm start
